var selectAddress;var linkMyWallet=function(){if(ethereum){web3Provider=ethereum;try{ethereum.enable()}catch(error){tishi("user cancel");return}}else if(web3){web3Provider=web3.currentProvider;console.log("web3.currentProvider:")}else{web3Provider=new Web3.providers.HttpProvider("http://localhost:8545");console.log("https://http-testnet.hecochain.com")}web3js=new Web3(web3Provider)};var web3jsInit=function(){var Inval=setInterval(function(){linkMyWallet();if(web3js){web3js.eth.getAccounts(function(error,result){if(!error){selectAddress=result[0];$("#selectAddress").text(getSimpleAddress(selectAddress));contractInstanceInit();window.clearInterval(Inval)}})}},2000)};web3jsInit();var gasPrice="50000000";var swapToolContract="0xB8fAcB66273265Ab50e7C0329EcE2F2174c7E962";var swapRouterContract="0xA40aDF2BEd98cdE5EC3C6De3f2C964858cC6246e";var WETHControlContractInstance;var ToolControlContractInstance;var RouterControlContractInstance;var contractInstanceInit=function(){WETHControlContractInstance=new web3js.eth.Contract(WETHAbi,wbnbContract,{from:selectAddress,gasPrice:"0",});ToolControlContractInstance=new web3js.eth.Contract(SwapToolAbi,swapToolContract,{from:selectAddress,gasPrice:"0"},);RouterControlContractInstance=new web3js.eth.Contract(SwapRouterExtendAbi,swapRouterContract,{from:selectAddress,gasPrice:"0"},);pageDataInit()};var allowanceAmount=0;var haveAmount=0;var allowanceLpAmount=0;var haveLpAmount=0;var userDepositAmount=0;var nodeBnbPrice=0;var shareShipRes=0;var userBnbRes=0;var depositDataInit=function(){swapTokenDataInit();getTokenListInfo()};var swapTokenDataInit=function(){if(!selectAddress){console.log("区块链数据获取中…… ");return}var fromTokenContract=$("#fromTokenContract").val();var toTokenContract=$("#toTokenContract").val();console.log("fromTokenContract "+fromTokenContract);console.log("toTokenContract "+toTokenContract);if(!fromTokenContract||!toTokenContract)return;initSwapRouterPath(fromTokenContract,toTokenContract);ToolControlContractInstance.methods.getTokenBalance(fromTokenContract,toTokenContract,selectAddress).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("swapTokenDataInit getTokenBalance");console.log(res);fromdecimals=res[2]*1;todecimals=res[3]*1;var oneFromAmountWei=decimalToBigInteger(0.1,fromdecimals);var _testFromString=res[0]+"";var _testFromWei="";if(_testFromString.length>2){_testFromWei=_testFromString.slice(1)}fromTokenBalance=bigintToDecimal8SigFigs(res[0],fromdecimals);var toTokenBalance=bigintToDecimal8SigFigs(res[1],todecimals);$("#fromTokenBalance").text(fromTokenBalance);$("#toTokenBalance").text(toTokenBalance);if((fromTokenContract==bnbContract&&toTokenContract==WBNBCONTRACT)||(fromTokenContract==WBNBCONTRACT&&toTokenContract==bnbContract)||fromTokenContract==toTokenContract){$("#oneFromTokenToTokenAmount").text(1.0)}else{getBestSwapRouter(oneFromAmountWei,todecimals,_testFromWei);fromdAllowanceAmount=bigintToDecimal8SigFigs(res[4],fromdecimals);console.log("fromdAllowanceAmount fromdAllowanceAmount:"+fromdAllowanceAmount,);if(fromdAllowanceAmount*1.0>=fromTokenBalance*1.0){$("#swapToken2Token").show();$("#swapapproveBtn").hide()}else{$("#swapapproveBtn").show();$("#swapToken2Token").hide()}}})};var userBnbAmount=0;var fromTokenBalance=0;var fromdAllowanceAmount=0;var fromdecimals;var todecimals;var bestPath;var swapMinToAmountWei;var getBestSwapRouter=function(_fromOne,_outDecimals,_testFromWei){var _customSlippageValue=parseInt(customSlippageValue*10);console.log("getBestSwapRouter swapTokenAmountDataInit customSlippageValue;"+_customSlippageValue,);var fromTokenContract=$("#fromTokenContract").val();ToolControlContractInstance.methods.findOptimalPathFixedWithLossRate(_fromOne,_customSlippageValue,path2,path3,path4,path5,path6,).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("findOptimalPathFixedWithLossRate findOptimalPathFixedWithLossRate",);console.log(res);bestPath=res[0];var getToTokenAmount=bigintToDecimal8SigFigs(res[1],_outDecimals);$("#oneFromTokenToTokenAmount").text((getToTokenAmount*10).toFixed(4));console.log("findOptimalPathFixed getToTokenAmount"+getToTokenAmount)})};var fromTokenInputMax=function(){var fromTokenAmount=$("#fromTokenBalance").text();var fromTokenContract=$("#fromTokenContract").val();if(fromTokenContract==bnbContract){if(fromTokenAmount*1>0.001){fromTokenAmount=fromTokenAmount-0.001;fromTokenAmount=(fromTokenAmount*1).toFixed(fromdecimals)}else{fromTokenAmount=0}}$("#fromTokenInput").val(fromTokenAmount);swapTokenAmountDataInit(fromTokenAmount,0)};var swapTokenAmountDataInit=function(fromAmount,toAmount){var _customSlippageValue=parseInt(customSlippageValue*10+3);if(fromAmount>0){console.log(fromAmount>fromdAllowanceAmount*1.0);var fromTokenContract=$("#fromTokenContract").val();var toTokenContract=$("#toTokenContract").val();if((fromTokenContract==bnbContract&&toTokenContract==WBNBCONTRACT)||(fromTokenContract==WBNBCONTRACT&&toTokenContract==bnbContract)||fromTokenContract==toTokenContract){$("#toTokenInput").val(fromAmount);return}if(fromAmount>fromdAllowanceAmount*1.0){$("#swapapproveBtn").show();$("#swapToken2Token").hide()}else{$("#swapapproveBtn").hide();$("#swapToken2Token").show()}var _fromAmountWei=decimalToBigInteger(fromAmount,fromdecimals);ToolControlContractInstance.methods.findOptimalPathFixedWithLossRate(_fromAmountWei,_customSlippageValue,path2,path3,path4,path5,path6,).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("findOptimalPathFixedWithLossRate findOptimalPathFixedWithLossRate",);console.log(res);bestPath=res[0];var toTokenBalance=bigintToDecimal8SigFigs(res[1],todecimals);swapMinToAmountWei=res[2]+"";$("#toTokenInput").val(toTokenBalance)})}else{$("#toTokenInput").val("")}};var approveTokenCheck=function(){approveFromToken2router()};var approveFromToken2router=function(){tishi("链上下发成功，稍等执行");var fromTokenContract=$("#fromTokenContract").val();var fromTokenContractInstance=new web3js.eth.Contract(TokenAbi,fromTokenContract,{from:selectAddress,gasPrice:"0"},);fromTokenContractInstance.methods.approve(swapRouterContract,"9999999999999000000000000000000000000000000000",).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},2000)})};var copyAddress=function(){if(selectAddress){copycontext(selectAddress)}else{tishi("钱包地址正在加载！")}};var swapToken2Token=function(){var _customSlippageValue=parseInt(customSlippageValue*10+3);console.log("swapTokenAmountDataInit customSlippageValue;"+_customSlippageValue,);var fromTokenContract=$("#fromTokenContract").val();var toTokenContract=$("#toTokenContract").val();if(fromTokenContract==toTokenContract){tishi("交易对不存在");return}var fromAmount=$("#fromTokenInput").val();console.log("fromAmount fromAmount-----"+fromAmount+"-----");if(!fromAmount||fromAmount*1.0==0||fromAmount.length<1){tishi("输入错误");return}var times=1;if(BATCH_TRADE_ENABLED){times=$("#batchCount").val();times=parseInt(times)}if(fromTokenBalance*1.0>=fromAmount){var _fromAmountWei=decimalToBigInteger(fromAmount,fromdecimals);if(fromTokenContract==bnbContract){if(toTokenContract==WBNBCONTRACT){deposit(_fromAmountWei)}else{multipleSwapExactETHForTokensSupportingFeeOnTransferTokensCheck(_fromAmountWei,times,)}}else if(toTokenContract==bnbContract){if(fromTokenContract==WBNBCONTRACT){withdraw(_fromAmountWei)}else{multipleSwapExactTokensForETHSupportingFeeOnTransferTokensCheck(_fromAmountWei,times,)}}else{multipleSwapExactTokensForTokensSupportingFeeOnTransferTokensCheck(_fromAmountWei,times,)}}else{tishi("余额不足")}};var multipleSwapExactTokensForTokensSupportingFeeOnTransferTokensCheck=function(_fromAmountWei,times){openAuditModal();RouterControlContractInstance.methods.multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens(_fromAmountWei,"0",bestPath,selectAddress,"100000000000000000000",times,).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens then",);console.log(res);$("#tokenSwapStatsSuccess").show();var userGetToTokenAmount=bigintToDecimal8SigFigs(res,todecimals);var userGetToTokenMaxAmount=$("#toTokenInput").val();var userLossRate=0;if(userGetToTokenMaxAmount*1>=userGetToTokenAmount*1){var userLossAmount=userGetToTokenMaxAmount-userGetToTokenAmount;var userLossRate=(userLossAmount*100)/userGetToTokenMaxAmount}if(userLossRate<=0.2){userLossRate=0}if(userLossRate>0.2){userLossRate=userLossRate-0.2}$("#tokenSwapSlippageRate").text(userLossRate.toFixed(2));if(userLossRate<customSlippageValue){var userGetToTokenMinAmount=(userGetToTokenAmount*0.99).toFixed(todecimals,);var userGetToTokenMinAmountWei=decimalToBigInteger(userGetToTokenMinAmount,todecimals,);multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens(_fromAmountWei,userGetToTokenMinAmountWei,times,)}else{tishi("滑点超出用户可接受的最大限额！")}}).catch(function(error){console.log("multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens catch",);console.log(error);$("#tokenSwapSlippageRate").text(100);$("#tokenSwapStatsFail").show()})};var multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens=function(_fromAmountWei,_userGetToTokenMinAmountWei,times,){RouterControlContractInstance.methods.multipleSwapExactTokensForTokensSupportingFeeOnTransferTokens(_fromAmountWei,_userGetToTokenMinAmountWei,bestPath,selectAddress,"100000000000000000000",times,).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();closeAuditModal();setTimeout(function(){swapTokenDataInit()},1000)}).catch(function(error){console.log("交易异常：",error);if(error.message.includes("user rejected")||error.message.includes("拒绝")||error.message.includes("User rejected")){tishi("你已取消交易授权");closeAuditModal();return}if(error.message.includes("insufficient funds")){tishi("GAS余额不足（含手续费）")}else{console.log("交易失败："+error.message.slice(0,50)+"...")}})};var multipleSwapExactETHForTokensSupportingFeeOnTransferTokensCheck=function(_fromAmountWei,times,){openAuditModal();console.log("_fromAmountWei :"+_fromAmountWei);console.log("times :"+times);RouterControlContractInstance.methods.multipleSwapExactETHForTokensSupportingFeeOnTransferTokens("0",bestPath,selectAddress,"100000000000000000000",times,).call({from:selectAddress,gasPrice:"0",value:_fromAmountWei}).then(function(res){console.log("multipleSwapExactETHForTokensSupportingFeeOnTransferTokens then",);console.log(res);$("#tokenSwapStatsSuccess").show();var userGetToTokenAmount=bigintToDecimal8SigFigs(res,todecimals);var userGetToTokenMaxAmount=$("#toTokenInput").val();var userLossRate=0;if(userGetToTokenMaxAmount*1>=userGetToTokenAmount*1){var userLossAmount=userGetToTokenMaxAmount-userGetToTokenAmount;var userLossRate=(userLossAmount*100)/userGetToTokenMaxAmount}if(userLossRate<=0.2){userLossRate=0}if(userLossRate>0.2){userLossRate=userLossRate-0.2}$("#tokenSwapSlippageRate").text(userLossRate.toFixed(2));if(userLossRate<customSlippageValue){var userGetToTokenMinAmount=(userGetToTokenAmount*0.99).toFixed(todecimals,);var userGetToTokenMinAmountWei=decimalToBigInteger(userGetToTokenMinAmount,todecimals,);multipleSwapExactETHForTokensSupportingFeeOnTransferTokens(_fromAmountWei,userGetToTokenMinAmountWei,times,)}else{tishi("滑点超出用户可接受的最大限额！")}}).catch(function(error){console.log("multipleSwapExactETHForTokensSupportingFeeOnTransferTokens catch callStatic ",);console.log(error);$("#tokenSwapSlippageRate").text(100);$("#tokenSwapStatsFail").show()})};var multipleSwapExactETHForTokensSupportingFeeOnTransferTokens=function(_fromAmountWei,_userGetToTokenMinAmountWei,times,){RouterControlContractInstance.methods.multipleSwapExactETHForTokensSupportingFeeOnTransferTokens(_userGetToTokenMinAmountWei,bestPath,selectAddress,"100000000000000000000",times,).send({from:selectAddress,gasPrice:gasPrice,value:_fromAmountWei}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();closeAuditModal();setTimeout(function(){swapTokenDataInit()},1000)}).catch(function(error){console.log("交易异常：",error);if(error.message.includes("user rejected")||error.message.includes("拒绝")||error.message.includes("User rejected")){tishi("你已取消交易授权");closeAuditModal();return}if(error.message.includes("insufficient funds")){tishi("GAS余额不足（含手续费）")}else{console.log("交易失败："+error.message.slice(0,50)+"...")}})};var multipleSwapExactTokensForETHSupportingFeeOnTransferTokensCheck=function(_fromAmountWei,times,){openAuditModal();console.log("multipleSwapExactTokensForETHSupportingFeeOnTransferTokens _fromAmountWei："+_fromAmountWei,);console.log("multipleSwapExactTokensForETHSupportingFeeOnTransferTokens times: "+times,);RouterControlContractInstance.methods.multipleSwapExactTokensForETHSupportingFeeOnTransferTokens(_fromAmountWei,"0",bestPath,selectAddress,"100000000000000000000",times,).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("multipleSwapExactTokensForETHSupportingFeeOnTransferTokens then",);console.log(res);$("#tokenSwapStatsSuccess").show();var userGetToTokenAmount=bigintToDecimal8SigFigs(res,todecimals);var userGetToTokenMaxAmount=$("#toTokenInput").val();var userLossRate=0;if(userGetToTokenMaxAmount*1>=userGetToTokenAmount*1){var userLossAmount=userGetToTokenMaxAmount-userGetToTokenAmount;var userLossRate=(userLossAmount*100)/userGetToTokenMaxAmount}if(userLossRate<=0.2){userLossRate=0}if(userLossRate>0.2){userLossRate=userLossRate-0.2}$("#tokenSwapSlippageRate").text(userLossRate.toFixed(2));if(userLossRate<customSlippageValue){console.log("multipleSwapExactTokensForETHSupportingFeeOnTransferTokens then userLossRate:"+userLossRate,);console.log(userGetToTokenAmount);var userGetToTokenMinAmount=(userGetToTokenAmount*0.99).toFixed(todecimals,);console.log(userGetToTokenMinAmount);var userGetToTokenMinAmountWei=decimalToBigInteger(userGetToTokenMinAmount,todecimals,);console.log(userGetToTokenMinAmountWei);multipleSwapExactTokensForETHSupportingFeeOnTransferTokens(_fromAmountWei,userGetToTokenMinAmountWei,times,)}else{tishi("滑点超出用户可接受的最大限额！")}}).catch(function(error){console.log("multipleSwapExactTokensForETHSupportingFeeOnTransferTokens catch",);console.log(error);$("#tokenSwapSlippageRate").text(100);$("#tokenSwapStatsFail").show()})};var multipleSwapExactTokensForETHSupportingFeeOnTransferTokens=function(_fromAmountWei,_userGetToTokenMinAmountWei,times,){RouterControlContractInstance.methods.multipleSwapExactTokensForETHSupportingFeeOnTransferTokens(_fromAmountWei,_userGetToTokenMinAmountWei,bestPath,selectAddress,"100000000000000000000",times,).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();closeAuditModal();setTimeout(function(){swapTokenDataInit()},1000)}).catch(function(error){console.log("交易异常：",error);if(error.message.includes("user rejected")||error.message.includes("拒绝")||error.message.includes("User rejected")){tishi("你已取消交易授权");closeAuditModal();return}if(error.message.includes("insufficient funds")){tishi("GAS余额不足（含手续费）")}else{console.log("交易失败："+error.message.slice(0,50)+"...")}})};var swapExactTokensForTokensSupportingFeeOnTransferTokens=function(_fromAmountWei,){RouterControlContractInstance.methods.swapExactTokensForTokensSupportingFeeOnTransferTokens(_fromAmountWei,swapMinToAmountWei,bestPath,selectAddress,"100000000000000000000",).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},1000)})};var swapExactTokensForETHSupportingFeeOnTransferTokens=function(_fromAmountWei,){RouterControlContractInstance.methods.swapExactTokensForETHSupportingFeeOnTransferTokens(_fromAmountWei,swapMinToAmountWei,bestPath,selectAddress,"100000000000000000000",).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},1000)})};var swapExactETHForTokensSupportingFeeOnTransferTokens=function(_fromAmountWei,){RouterControlContractInstance.methods.swapExactETHForTokensSupportingFeeOnTransferTokens(swapMinToAmountWei,bestPath,selectAddress,"100000000000000000000",).send({from:selectAddress,gasPrice:gasPrice,value:_fromAmountWei}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},1000)})};var deposit=function(_fromAmountWei){WETHControlContractInstance.methods.deposit().send({from:selectAddress,gasPrice:gasPrice,value:_fromAmountWei}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},1000)})};var withdraw=function(_fromAmountWei){WETHControlContractInstance.methods.withdraw(_fromAmountWei).send({from:selectAddress,gasPrice:gasPrice}).then(function(res){console.log(res);tishi("完成");swapTokenDataInit();setTimeout(function(){swapTokenDataInit()},1000)})};var pageDataInit=function(){depositDataInit()};var findTokenDetail=function(){console.log("findTokenDetail");const findTokenContract=document.getElementById("tokenSearch").value.trim();console.log(findTokenContract);if(!findTokenContract)return;ToolControlContractInstance.methods.getTokenDetail(findTokenContract,selectAddress).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("findTokenDetail getTokenDetail");console.log(res);var tokenName=res[0];var tokenSymbol=res[1];var tokenDecimals=res[2];userBnbAmount=web3js.utils.fromWei(res[4]);var userTokenBalance=bigintToDecimal8SigFigs(res[3],tokenDecimals);$("#findTokenContract").val(findTokenContract);document.getElementById("tokenSearch_tokenName").textContent=tokenName;document.getElementById("tokenSearch_tokenSymbol").textContent=tokenSymbol;document.getElementById("tokenSearch_tokenDecimals").textContent=tokenDecimals;document.getElementById("tokenSearch_tokenBalance").textContent=userTokenBalance+" "+tokenSymbol;document.getElementById("tokenPreview").classList.add("show");$("#swapTokenList").html("")})};var getTokenListInfo=function(){console.log("getTokenListInfo getTokenListInfo");var userTokenList=getContractAddresses();console.log("getTokenListInfo getTokenListInfo"+userTokenList.length);ToolControlContractInstance.methods.getTokenListInfo(userTokenList,selectAddress).call({from:selectAddress,gasPrice:"0"}).then(function(res){console.log("getTokenListInfo getTokenListInfo");console.log(res);var size=res.length;var contractAddrss;var tokenDecimals;var tokenAmount;for(var i=0;i<size;i++){contractAddrss=userTokenList[i];tokenDecimals=tokenListObject[contractAddrss].decimals;var tokenAmountWei=res[i];tokenAmount=bigintToDecimal8SigFigs(tokenAmountWei,tokenDecimals);$("#manage_tokenBlance_"+contractAddrss).text(tokenAmount)}})};